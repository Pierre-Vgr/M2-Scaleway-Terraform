## Create instance + BDD
  terraform {
    required_providers {
      scaleway = {
        source = "scaleway/scaleway"
      }
    }
    required_version = ">= 0.13"
  }
  provider "scaleway" {
    access_key      = "SCW0FHXY5FS9F5C7DPKC"
    secret_key      = "6ac6428b-5dd9-4d29-9db1-133e661e3162"
    project_id      = "59972b2a-5ceb-447d-9266-ef00f9591ce1"
    zone            = "fr-par-1"
    region          = "fr-par"
  }
    resource "scaleway_instance_ip" "public_ip" {}
    resource "scaleway_instance_volume" "data" {
    size_in_gb = 10
    type = "l_ssd"
    }
    resource "scaleway_instance_server" "main" {
    type  = "DEV1-S"
    image = "ubuntu_focal"
    name = "rdom-pvig-instance"

    ip_id = scaleway_instance_ip.public_ip.id

    additional_volume_ids = [ scaleway_instance_volume.data.id ]
      
    root_volume {
      size_in_gb = 10
    }
  }
  ## Create DB
    resource "scaleway_rdb_instance" "main" {
    name           = "rdom-pvig-rdb"
    node_type      = "DB-DEV-S"
    engine         = "MySQL-8"
    is_ha_cluster  = false
    disable_backup = true
    user_name      = "romain"
    volume_size_in_gb = 10
    volume_type = "bssd"
    password       = "Azerty77$"
    
    private_network {
      pn_id = scaleway_vpc_private_network.main.id
  }
  }
## Create VPC public

    resource scaleway_vpc_public_gateway_ip main {
}

    resource scaleway_vpc_public_gateway_dhcp main {
    subnet = "192.168.100.0/24"
}

    resource scaleway_vpc_public_gateway main {
    name = "rdomgate"
    type = "VPC-GW-S"
    ip_id = scaleway_vpc_public_gateway_ip.main.id
}

    resource scaleway_vpc_gateway_network main {
    gateway_id = scaleway_vpc_public_gateway.main.id
    private_network_id = scaleway_vpc_private_network.main.id
    dhcp_id = scaleway_vpc_public_gateway_dhcp.main.id
    cleanup_dhcp = true
    enable_masquerade = true
    depends_on = [scaleway_vpc_public_gateway_ip.main, scaleway_vpc_private_network.main]
}

    resource scaleway_vpc_public_gateway_dhcp_reservation main {
    gateway_network_id = scaleway_vpc_gateway_network.main.id
    mac_address = scaleway_instance_server.main.private_network.0.mac_address
    ip_address = "192.168.100.1"
}






## Security groups
resource "scaleway_instance_security_group" "allow_all" {
}

resource "scaleway_instance_security_group" "Security_TP" {
  inbound_default_policy = "drop" # By default we drop incoming traffic that do not match any inbound_rule

  inbound_rule {
    action = "accept"
    port   = 22
    ip     = "85.169.101.162"
  }

  inbound_rule {
    action = "accept"
    port   = 80
  }

  inbound_rule {
    action     = "accept"
    protocol   = "TCP"
    port = 3306
    ip_id = scaleway_instance_ip.public_ip.id
  }
}
resource scaleway_vpc_public_gateway_ip main {
}

resource scaleway_vpc_public_gateway_dhcp main {
    subnet = "192.168.1.0/24"
}

resource scaleway_vpc_public_gateway main {
    name = "foobar"
    type = "VPC-GW-S"
    ip_id = scaleway_vpc_public_gateway_ip.main.id
}

resource scaleway_vpc_gateway_network main {
    gateway_id = scaleway_vpc_public_gateway.main.id
    private_network_id = scaleway_vpc_private_network.main.id
    dhcp_id = scaleway_vpc_public_gateway_dhcp.main.id
    cleanup_dhcp = true
    enable_masquerade = true
    depends_on = [scaleway_vpc_public_gateway_ip.main, scaleway_vpc_private_network.main]
}

resource scaleway_vpc_public_gateway_dhcp_reservation main {
    gateway_network_id = scaleway_vpc_gateway_network.main.id
    mac_address = scaleway_instance_server.main.private_network.0.mac_address
    ip_address = "192.168.1.1"
}


## VPV gateway public
resource scaleway_vpc_private_network main {
    name = "rdomVPC"
}

resource "scaleway_instance_server" "main" {
    image = "ubuntu_jammy"
    type  = "DEV1-S"
    zone = "fr-par-1"

    private_network {
        pn_id = scaleway_vpc_private_network.main.id
    }
}

resource scaleway_vpc_public_gateway_ip main {
}

resource scaleway_vpc_public_gateway_dhcp main {
    subnet = "192.168.1.0/24"
}

resource scaleway_vpc_public_gateway main {
    name = "foobar"
    type = "VPC-GW-S"
    ip_id = scaleway_vpc_public_gateway_ip.main.id
}

resource scaleway_vpc_gateway_network main {
    gateway_id = scaleway_vpc_public_gateway.main.id
    private_network_id = scaleway_vpc_private_network.main.id
    dhcp_id = scaleway_vpc_public_gateway_dhcp.main.id
    cleanup_dhcp = true
    enable_masquerade = true
    depends_on = [scaleway_vpc_public_gateway_ip.main, scaleway_vpc_private_network.main]
}

resource scaleway_vpc_public_gateway_dhcp_reservation main {
    gateway_network_id = scaleway_vpc_gateway_network.main.id
    mac_address = scaleway_instance_server.main.private_network.0.mac_address
    ip_address = "192.168.1.1"
}